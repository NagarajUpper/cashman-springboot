package com.wns.cassdispense.cashmanspringboot.service.impl;

import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import com.wns.cassdispense.cashmanspringboot.dao.CashDao;
import com.wns.cassdispense.cashmanspringboot.model.DenominationModel;
import com.wns.cassdispense.cashmanspringboot.model.DenominationModelList;
import com.wns.cassdispense.cashmanspringboot.service.CashService;

@Service
public class CashServiceImpl implements CashService {

	@Autowired
	private CashDao cashDao;

	@Override
	public void addNotes(DenominationModelList list) {

		cashDao.addNotes(list);

	}

	@Override
	public DenominationModelList countNotes() {

		DenominationModelList countNotess = cashDao.countNotess();

		return countNotess;
	}

	@Override
	public String getcash(int amount) {

		DenominationModelList countNotess = cashDao.countNotess();
		String res = cashProcess2(countNotess, amount);

		return res;
	}

	private String cashProcess2(DenominationModelList countNotess, int amount) {
		Map<String, Integer> existingCount = new HashMap<>();
		List<DenominationModel> list = countNotess.getList();
		int twentycount = 0;
		int fiftycount = 0;

		for (DenominationModel denominationModel : list) {
			if (denominationModel.getDenominationValue().equals("20")) {
				twentycount = denominationModel.getDenominationValueCount();

			}
			if (denominationModel.getDenominationValue().equals("50")) {
				fiftycount = denominationModel.getDenominationValueCount();

			}

		}
		existingCount.put("20", twentycount);
		existingCount.put("50", fiftycount);

		Map<String, Integer> result = getmoney(existingCount, amount);
		DenominationModelList denominationModelList = new DenominationModelList();

		List<DenominationModel> updatelist = new ArrayList<>();

		for (DenominationModel denominationModel : list) {
			DenominationModel model = new DenominationModel();
			if (denominationModel.getDenominationValue().equals("20")) {
				model.setDenominationValue("20");
				model.setDenominationValueCount(result.get("20"));
				updatelist.add(model);

			}
			if (denominationModel.getDenominationValue().equals("50")) {
				model.setDenominationValue("50");
				model.setDenominationValueCount(result.get("50"));
				updatelist.add(model);

			}

		}

		denominationModelList.setList(updatelist);

		cashDao.updateNote(denominationModelList);
		
		return "50 Notes are:"+result.get("Count50")+" & 20 Notes are : "+result.get("Count20") + "issued";

	}

	private Map<String, Integer> getmoney(Map<String, Integer> existingCount, int amount) {

		int totalCount50 = 0;
		int totalCount20 = 0;
		int givenAmt = amount;

		if (givenAmt >= 50) {
			double a = (double) amount / (double) 50;
			if (existingCount.get("50") >= a) {
				totalCount50 = (int) a;
				givenAmt = (int) ((a - totalCount50) * 50);
				existingCount.put("50", existingCount.get("50") - totalCount50);

			} else {

				totalCount50 = existingCount.get("50");
				givenAmt = givenAmt - totalCount50 * 50;
				existingCount.put("50", existingCount.get("50") - totalCount50);
			}

		}

		if (givenAmt >= 20) {
			double a = (double) givenAmt / (double) 20;
			if (existingCount.get("20") >= a) {
				totalCount20 = (int) a;
				givenAmt = (int) ((a - totalCount20) * 20);
				existingCount.put("20", existingCount.get("20") - totalCount20);
			} else {
				totalCount20 = existingCount.get("20");
				givenAmt = givenAmt - totalCount20 * 20;
				existingCount.put("20", existingCount.get("20") - totalCount20);

			}

		}
		existingCount.put("Count20", totalCount20);
		existingCount.put("Count50", totalCount50);

		return existingCount;
	}

}
